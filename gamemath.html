<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏•‡∏Ç</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/gamemath.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- Feedback Overlay -->
<div id="feedbackOverlay">
  <div id="feedbackMessage"></div>
</div>

<h2>‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: <span id="topicName"></span></h2>

<div id="gameContainer">
  <div class="question-container">
    <div class="question-text" id="questionText"></div>
  </div>

  <div id="zones">
    <div id="correctZone" class="zone">‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á</div>
  </div>
  
  <p id="scoreDisplay">Score: <span id="score">0</span></p>
</div>

<!-- Popup -->
<div id="scorePopup">
  <p style="font-size:20px; font-weight:600; margin-bottom:8px; color:#555;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: <span id="topicDisplay"></span></p>
  <p style="font-size:24px; font-weight:600; margin-bottom:10px; color:#666;">‡∏ä‡∏∑‡πà‡∏≠: <span id="playerNameDisplay"></span></p>
  <p id="resultMessage" style="font-size:28px; font-weight:700; margin-bottom:15px;"></p>
  <p style="font-size:32px; font-weight:700; margin:20px 0;">üéâ Your Score: <span id="finalScore"></span> üéâ</p>
  
  <div style="display: flex; justify-content: center; gap: 15px; margin: 25px 0;">
    <button onclick="playAgain()" title="‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      üîÑ
    </button>
    <div style="position: relative;">
      <button onclick="toggleShareMenu()" title="‡πÅ‡∏ä‡∏£‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        üîó
      </button>
      <div id="shareMenu" style="display: none; position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%); border-radius: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden; min-width: 180px; z-index: 10000; border: 3px solid #2196F3;">
        <button onclick="shareResult(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #2196F3, #1E88E5); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #1976D2, #1565C0)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #2196F3, #1E88E5)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üîó</span> ‡πÅ‡∏ä‡∏£‡πå
        </button>
        <button onclick="saveResult(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #FF9800, #F57C00); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; border-top: 2px solid rgba(255,255,255,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #F57C00, #E65100)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #FF9800, #F57C00)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üì•</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        </button>
      </div>
    </div>
    <button onclick="closePopup()" title="‡∏õ‡∏¥‡∏î" style="background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      ‚úñ
    </button>
  </div>
</div>

<script>
let audioCtx, baseFreq = 200;
const sparkleChars = ['‚ú®', 'üåü', 'üí´', '‚≠ê'];
let createdAnswers = {};
let score = 0;
let gameStarted = false;
let currentQuestionIndex = 0;
let allQuestions = [];

// ‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å localStorage
let teacherConfig = JSON.parse(localStorage.getItem('emojiGameConfig') || '{}');
document.getElementById('topicName').innerText = teacherConfig.topic || 'Unknown';

// ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
if (teacherConfig.questions && teacherConfig.questions.length > 0) {
  allQuestions = [...teacherConfig.questions];
  // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå
  allQuestions.sort(() => Math.random() - 0.5);
}

// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
document.getElementById('gameContainer').style.display = 'block';
gameStarted = true;

// ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π


// ‡πÅ‡∏™‡∏î‡∏á feedback ‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î
function showFeedback(isCorrect) {
  const overlay = document.getElementById('feedbackOverlay');
  const message = document.getElementById('feedbackMessage');
  
  if (isCorrect) {
    message.innerText = '‚úÖ';
    message.style.color = '#4CAF50';
  } else {
    message.innerText = '‚ùå';
    message.style.color = '#f44336';
  }
  
  overlay.style.display = 'flex';
  
  setTimeout(() => {
    overlay.style.display = 'none';
  }, 800);
}


// particle effect
function createParticle(x, y) {
  const p = document.createElement('div');
  p.className = 'particle';
  p.innerText = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
  p.style.left = `${x}px`;
  p.style.top = `${y}px`;
  p.style.transform = `scale(${Math.random() * 1.5 + 0.5})`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 600);
}

// ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏≤‡∏Å
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const s = audioCtx.createBufferSource();
    s.connect(audioCtx.destination);
    s.start();
  }
}

function playSlideTone(freqStart, freqEnd) {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freqStart, audioCtx.currentTime);
  osc.frequency.linearRampToValueAtTime(freqEnd, audioCtx.currentTime + 0.15);
  gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.2);
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
function createDraggableAnswer(answerText, answerId, isCorrect, optStartX, optStartY) {
  if (createdAnswers[answerId]) return;

  const answerDiv = document.createElement('div');
  answerDiv.classList.add('answer-item');
  answerDiv.textContent = answerText;

  // If provided, use explicit start positions (from loadQuestion layout planner)
  const answerWidth = 120; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (used for fallback)
  const startX = (typeof optStartX === 'number') ? optStartX : (50 + Math.random() * (window.innerWidth - 200));
  const startY = (typeof optStartY === 'number') ? optStartY : (window.innerHeight - 250); // ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á 250px

  answerDiv.style.left = `${startX}px`;
  answerDiv.style.top = `${startY}px`;
  answerDiv.style.transform = 'none';

  let offsetX, offsetY;
  
  function dragMove(posX, posY) {
    answerDiv.style.left = `${posX}px`;
    answerDiv.style.top = `${posY}px`;
    createParticle(posX + 50, posY + 50);
    playSlideTone(baseFreq, baseFreq + 400);
    baseFreq = baseFreq >= 800 ? 200 : baseFreq + 50;
  }

  // Desktop
  answerDiv.addEventListener('mousedown', e => {
    initAudio();
    e.preventDefault();
    offsetX = e.clientX - answerDiv.offsetLeft;
    offsetY = e.clientY - answerDiv.offsetTop;
    
    function onMove(e) {
      dragMove(e.clientX - offsetX, e.clientY - offsetY);
    }
    
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      checkDrop(answerDiv, answerId, isCorrect);
    }
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Mobile
  answerDiv.addEventListener('touchstart', e => {
    initAudio();
    const t = e.touches[0];
    offsetX = t.clientX - answerDiv.offsetLeft;
    offsetY = t.clientY - answerDiv.offsetTop;
  });
  
  answerDiv.addEventListener('touchmove', e => {
    const t = e.touches[0];
    dragMove(t.clientX - offsetX, t.clientY - offsetY);
  });
  
  answerDiv.addEventListener('touchend', e => {
    checkDrop(answerDiv, answerId, isCorrect);
  });

  document.body.appendChild(answerDiv);
  createdAnswers[answerId] = answerDiv;
}

function checkDrop(answerDiv, answerId, isCorrect) {
  const rect = answerDiv.getBoundingClientRect();
  const correctZone = document.getElementById('correctZone').getBoundingClientRect();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  if (rect.left + rect.width / 2 > correctZone.left && rect.left + rect.width / 2 < correctZone.right &&
      rect.top + rect.height / 2 > correctZone.top && rect.top + rect.height / 2 < correctZone.bottom) {
    if (isCorrect) {
      // ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á = ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      showFeedback(true);
      score += 1;
      document.getElementById('score').innerText = score;
      setTimeout(() => nextQuestion(), 800);
    } else {
      // ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á = ‡∏ú‡∏¥‡∏î! ‡∏™‡∏Ñ‡∏¥‡∏õ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      showFeedback(false);
      setTimeout(() => nextQuestion(), 800);
    }
  }
  // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á = ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà
}

// ‡πÑ‡∏õ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
function nextQuestion() {
  // ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  Object.values(createdAnswers).forEach(div => div.remove());
  createdAnswers = {};
  
  currentQuestionIndex++;
  
  if (currentQuestionIndex >= allQuestions.length) {
    // ‡∏´‡∏°‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (score === allQuestions.length) {
      endGame('üéâ ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠!', '#4CAF50');
    } else {
      endGame('‚úÖ ‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', '#FF9800');
    }
  } else {
    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    loadQuestion(currentQuestionIndex);
  }
}

// ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
function endGame(message, color) {
  const totalQuestions = allQuestions.length;
  const percentage = totalQuestions > 0 ? (score / totalQuestions) : 0;
  
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
  let resultMessage = '';
  let resultColor = '';
  
  if (percentage === 1) {
    resultMessage = 'üèÜ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! üèÜ';
    resultColor = '#4CAF50';
  } else if (percentage >= 0.7) {
    resultMessage = 'üëè ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! üëè';
    resultColor = '#2196F3';
  } else if (percentage >= 0.5) {
    resultMessage = 'üòä ‡∏î‡∏µ‡∏°‡∏≤‡∏Å! üòä';
    resultColor = '#FF9800';
  } else if (percentage > 0) {
    resultMessage = 'üí™ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î! üí™';
    resultColor = '#FF5722';
  } else {
    resultMessage = 'üìö ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á! üìö';
    resultColor = '#f44336';
  }
  
  document.getElementById('topicDisplay').innerText = teacherConfig.topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  document.getElementById('playerNameDisplay').innerText = teacherConfig.playerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
  document.getElementById('resultMessage').innerText = resultMessage;
  document.getElementById('resultMessage').style.color = resultColor;
  document.getElementById('finalScore').innerText = `${score}/${allQuestions.length}`;
  document.getElementById('scorePopup').style.display = 'block';
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏ö‡πÄ‡∏Å‡∏° (‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)
function checkEndGame() {
  if (Object.keys(createdAnswers).length === 0) {
    nextQuestion();
  }
}

function closePopup() {
  document.getElementById('scorePopup').style.display = 'none';
  // ‡∏õ‡∏¥‡∏î share menu ‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
  const shareMenu = document.getElementById('shareMenu');
  if (shareMenu) shareMenu.style.display = 'none';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ä‡∏£‡πå
function toggleShareMenu() {
  const menu = document.getElementById('shareMenu');
  if (menu.style.display === 'none' || menu.style.display === '') {
    menu.style.display = 'block';
  } else {
    menu.style.display = 'none';
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
function playAgain() {
  location.reload();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF
async function shareResult() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const topic = teacherConfig.topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const playerName = teacherConfig.playerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
    const scoreText = document.getElementById('finalScore').innerText;
    const resultMessage = document.getElementById('resultMessage').innerText;
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    
    // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß
    doc.setFillColor(255, 255, 255);
    doc.rect(0, 0, 210, 297, 'F');
    
    // ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß - ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡πÑ‡∏•‡πà‡∏™‡∏µ
    const gradient = doc.setFillColor(93, 93, 180);
    doc.roundedRect(15, 15, 180, 25, 5, 5, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', 105, 25, { align: 'center' });
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text('Smart Classroom Learning System', 105, 33, { align: 'center' });
    
    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(1);
    doc.roundedRect(15, 50, 180, 35, 5, 5, 'S');
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(12);
    doc.text('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö', 105, 60, { align: 'center' });
    
    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏ç‡πà
    doc.setFontSize(32);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 180, 0);
    doc.text(scoreText, 60, 77, { align: 'center' });
    
    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    doc.setFillColor(255, 200, 100);
    doc.roundedRect(120, 64, 70, 15, 3, 3, 'F');
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 0, 0);
    doc.text(resultMessage, 155, 74, { align: 'center' });
    
    // ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
    doc.setFillColor(255, 220, 130);
    doc.rect(15, 95, 180, 10, 'F');
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.text('‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1 - ' + topic, 20, 102);
    
    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô
    doc.setDrawColor(200, 200, 200);
    doc.roundedRect(15, 110, 180, 45, 3, 3, 'S');
    doc.setFillColor(240, 240, 255);
    doc.rect(15, 110, 180, 8, 'F');
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(100, 100, 200);
    doc.text('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô', 105, 116, { align: 'center' });
    
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    let yPos = 125;
    
    doc.text('‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á:', 25, yPos);
    doc.text('10', 170, yPos, { align: 'right' });
    yPos += 8;
    doc.text('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô:', 25, yPos);
    doc.text('‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 170, yPos, { align: 'right' });
    yPos += 8;
    doc.text('‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:', 25, yPos);
    doc.text('4', 170, yPos, { align: 'right' });
    yPos += 8;
    doc.text('‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏≠‡∏ô:', 25, yPos);
    doc.text(playerName, 170, yPos, { align: 'right' });
    
    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
    doc.setDrawColor(200, 200, 200);
    doc.roundedRect(15, 165, 180, 35, 3, 3, 'S');
    doc.setFillColor(240, 240, 255);
    doc.rect(15, 165, 180, 8, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(100, 100, 200);
    doc.text('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', 105, 171, { align: 'center' });
    
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    yPos = 180;
    doc.text('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:', 25, yPos);
    doc.text('-', 170, yPos, { align: 'right' });
    yPos += 8;
    doc.text('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:', 25, yPos);
    doc.text(dateStr, 170, yPos, { align: 'right' });
    yPos += 8;
    doc.text('‡πÄ‡∏ß‡∏•‡∏≤:', 25, yPos);
    doc.text(timeStr, 170, yPos, { align: 'right' });
    
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞', 105, 225, { align: 'center' });
    doc.text('Smart Classroom Learning Management System', 105, 230, { align: 'center' });
    doc.text('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ ' + dateStr + ' ‡πÄ‡∏ß‡∏•‡∏≤ ' + timeStr, 105, 235, { align: 'center' });
    
    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
    doc.setFontSize(9);
    doc.setTextColor(0, 0, 0);
    doc.text('‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô', 150, 252);
    doc.setDrawColor(200, 200, 200);
    doc.line(145, 255, 185, 255);
    doc.setFontSize(8);
    doc.text('‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à', 165, 260, { align: 'center' });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF blob
    const pdfBlob = doc.output('blob');
    const fileName = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô_${playerName}_${Date.now()}.pdf`;
    
    // ‡∏•‡∏≠‡∏á‡πÅ‡∏ä‡∏£‡πå PDF
    if (navigator.share && navigator.canShare) {
      const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
      const shareData = {
        title: 'Game Result',
        files: [file]
      };
      
      if (navigator.canShare(shareData)) {
        await navigator.share(shareData);
        return;
      }
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    const url = URL.createObjectURL(pdfBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÅ‡∏•‡πâ‡∏ß! ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ');
    
  } catch (error) {
    console.error('Error sharing PDF:', error);
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå PDF ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF
function saveResult() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const topic = teacherConfig.topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const playerName = teacherConfig.playerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
    const scoreText = document.getElementById('finalScore').innerText;
    const resultMessage = document.getElementById('resultMessage').innerText;
    const date = new Date().toLocaleString('th-TH');
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    doc.setFillColor(251, 245, 230);
    doc.rect(0, 0, 210, 297, 'F');
    
    // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
    doc.setFillColor(74, 100, 10);
    doc.rect(0, 0, 210, 35, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.text('GAME RESULT', 105, 15, { align: 'center' });
    doc.setFontSize(18);
    doc.text('Mathematics Game', 105, 27, { align: 'center' });
    
    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    doc.setFillColor(255, 255, 255);
    doc.setDrawColor(235, 208, 158);
    doc.setLineWidth(2);
    doc.roundedRect(15, 45, 180, 90, 5, 5, 'FD');
    
    doc.setTextColor(37, 31, 3);
    let yPos = 60;
    
    // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Player Name:', 25, yPos);
    doc.setFont('helvetica', 'normal');
    doc.text(playerName, 70, yPos);
    yPos += 15;
    
    // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
    doc.setFont('helvetica', 'bold');
    doc.text('Topic:', 25, yPos);
    doc.setFont('helvetica', 'normal');
    doc.text(topic, 70, yPos);
    yPos += 15;
    
    // ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
    doc.setFont('helvetica', 'bold');
    doc.text('Result:', 25, yPos);
    doc.setFont('helvetica', 'normal');
    doc.text(resultMessage, 70, yPos);
    yPos += 20;
    
    // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤)
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.setTextColor(74, 100, 10);
    doc.text('Score:', 25, yPos);
    doc.text(scoreText, 70, yPos);
    yPos += 20;
    
    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.setFont('helvetica', 'normal');
    doc.text('Date: ' + date, 25, yPos);
    
    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢
    doc.setTextColor(150, 150, 150);
    doc.setFontSize(10);
    doc.text('Generated by Classroom Game System', 105, 280, { align: 'center' });
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå
    doc.save(`Result_${playerName}_${Date.now()}.pdf`);
    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
  } catch (error) {
    console.error('Error creating PDF:', error);
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
  }
}

// ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå
function loadQuestion(index) {
  if (!allQuestions || allQuestions.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
    window.location.href = 'teachermatch.html';
    return;
  }

  const question = allQuestions[index];
  createdAnswers = {};
  
  // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå
  document.getElementById('questionText').innerText = question.question;

  // ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
  const allAnswers = [];
  
  question.correctAnswers.forEach((answer, i) => {
    allAnswers.push({ text: answer, id: `correct-${i}`, isCorrect: true });
  });
  
  question.wrongAnswers.forEach((answer, i) => {
    allAnswers.push({ text: answer, id: `wrong-${i}`, isCorrect: false });
  });
  
  // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
  allAnswers.sort(() => Math.random() - 0.5);

  // Layout planner: compute non-overlapping start positions for all answers
  const answerWidth = 120;
  const answerHeight = 220; // increased height to provide more vertical space between rows
  const hSpacing = 64; // increased horizontal spacing (doubled) to avoid overlap
  const vSpacing = 40; // vertical spacing between rows (doubled)
  const total = allAnswers.length;

  // available width with small horizontal margins
  const margin = 24;
  const availableWidth = Math.max(200, window.innerWidth - margin * 2);

  // how many columns can fit
  const maxCols = Math.max(1, Math.floor((availableWidth + hSpacing) / (answerWidth + hSpacing)));
  const cols = Math.min(total, maxCols);
  const rows = Math.ceil(total / cols);

  // compute baseX centered for the number of columns
  const rowTotalWidth = cols * answerWidth + (cols - 1) * hSpacing;
  let baseX = (window.innerWidth - rowTotalWidth) / 2;
  baseX = Math.max(margin, baseX);

  // start from lower area but allow multiple rows upwards
  const bottomY = window.innerHeight - 160; // baseline from bottom

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠ ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß (multi-row)
  allAnswers.forEach((answer, i) => {
    const row = Math.floor(i / cols);
    const col = i % cols;
    const x = baseX + col * (answerWidth + hSpacing);
    const y = bottomY - row * (answerHeight + vSpacing);
    createDraggableAnswer(answer.text, answer.id, answer.isCorrect, x, y);
  });
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏°)
function initGame() {
  if (!allQuestions || allQuestions.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
    window.location.href = 'teachermatch.html';
    return;
  }

  score = 0;
  currentQuestionIndex = 0;
  document.getElementById('score').innerText = score;
  
  // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÅ‡∏£‡∏Å
  loadQuestion(0);
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
initGame();
</script>
</body>
</html>
